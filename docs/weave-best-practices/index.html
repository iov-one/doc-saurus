<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Best practices · Weave</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;best-practices&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#best-practices&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Best Practices&lt;/h1&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Best practices · Weave"/><meta property="og:type" content="website"/><meta property="og:url" content="https://iov-one.github.io/doc-saurus/"/><meta property="og:description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;best-practices&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#best-practices&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Best Practices&lt;/h1&gt;
"/><meta property="og:image" content="https://iov-one.github.io/doc-saurus/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://iov-one.github.io/doc-saurus/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/doc-saurus/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://iov-one.github.io/doc-saurus/blog/atom.xml" title="Weave Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://iov-one.github.io/doc-saurus/blog/feed.xml" title="Weave Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/doc-saurus/js/scrollSpy.js"></script><link rel="stylesheet" href="/doc-saurus/css/main.css"/><script src="/doc-saurus/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/doc-saurus/"><img class="logo" src="/doc-saurus/img/favicon.ico" alt="Weave"/><h2 class="headerTitleWithLogo">Weave</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/doc-saurus/docs/weave-tutorial1" target="_self">Getting Started</a></li><li class=""><a href="/doc-saurus/docs/doc4" target="_self">API</a></li><li class=""><a href="/doc-saurus/help" target="_self">Help</a></li><li class=""><a href="/doc-saurus/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Best Practices</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Weave Tutorial</h3><ul class=""><li class="navListItem"><a class="navItem" href="/doc-saurus/docs/weave-tutorial1">Getting Started</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Best Practices</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/doc-saurus/docs/weave-best-practices">Best practices</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Best practices</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="best-practices"></a><a href="#best-practices" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Best Practices</h1>
<hr>
<p>First of all to understand weave design philosophy and for the sake of programming well designed software, I advise you to read this fine-grained article:
<a href="https://blog.juliobiason.net/thoughts/things-i-learnt-the-hard-way/">Things I Learnt The Hard Way (in 30 Years of Software Development)</a> <br>
<br>
This documents content is curated from PR discussions of weave tutorial. If you follow the <em>PRs</em> section you can see how to implement blockchain app using weave.
And you can see how the development flow works and what are the issues you should have on your mind while moving forward.</p>
<h3><a class="anchor" aria-hidden="true" id="development-flow"></a><a href="#development-flow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Development flow</h3>
<ol>
<li><h4><a class="anchor" aria-hidden="true" id="codec"></a><a href="#codec" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Codec</h4>
<blockquote>
<p><a href="https://github.com/iov-one/tutorial/pull/1">PR#1</a>: <em>Create order book models</em></p>
</blockquote>
<p>Codec is the first the component that needs to be designed. Keep in mind that this part is the most important since whole module will depend on <em>codec</em>. You can think codec it as <em>model</em> in mvc pattern. Yet it is not simple as model. Codec defines the whole application state models and more.</p>
<ul>
<li><h4><a class="anchor" aria-hidden="true" id="state"></a><a href="#state" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>State</h4>
<pre><code class="hljs css language-protobuf"><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">Trade</span> </span>{
    weave.Metadata metadata = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">bytes</span> id = <span class="hljs-number">2</span> [(gogoproto.customname) = <span class="hljs-string">"ID"</span>];
    <span class="hljs-built_in">bytes</span> order_book_id = <span class="hljs-number">3</span> [(gogoproto.customname) = <span class="hljs-string">"OrderBookID"</span>];
    <span class="hljs-built_in">bytes</span> order_id = <span class="hljs-number">4</span> [(gogoproto.customname) = <span class="hljs-string">"OrderID"</span>];
    <span class="hljs-built_in">bytes</span> taker = <span class="hljs-number">5</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.Address"</span>];
    <span class="hljs-built_in">bytes</span> maker = <span class="hljs-number">6</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.Address"</span>];
    coin.Coin maker_paid = <span class="hljs-number">7</span>;
    coin.Coin taker_paid = <span class="hljs-number">8</span>;
    <span class="hljs-built_in">int64</span> executed_at = <span class="hljs-number">9</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.UnixTime"</span>];
}
</code></pre>
<p>As you can see above, weave is heavily using <code>bytes</code> for identites, addresses etc. At first glance this might seem difficult to handle but if you take a look at <a href="https://github.com/iov-one/tutorial/blob/master/x/orderbook/bucket.go#L125">x/orderbook/bucket</a> you can see it is very useful for indexing and performance</p>
<p>There are 2 critical points that needs to be explained in state models and messages.</p>
<p>Firstly, You must have noticed one and said what the hell is</p>
<pre><code class="hljs css language-protobuf">weave.Metadata metadata = <span class="hljs-number">1</span>;
</code></pre>
<p><code>weave.Metadata</code> allows you to use <em>Migration</em> extension. <code>Migration extension</code> allows upgrading the code on chain without any downtime. This will be explained in more detail in further sections.</p>
<p>Second one is how the magic <code>ID</code> field works. This will be explained in <a href="#Models">Models</a> section.</p></li>
<li><h4><a class="anchor" aria-hidden="true" id="message-definitions"></a><a href="#message-definitions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Message definitions</h4>
<pre><code class="hljs css language-protobuf"><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">CreateOrderMsg</span> </span>{
    weave.Metadata metadata = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">bytes</span> trader = <span class="hljs-number">2</span> [(gogoproto.casttype) = <span class="hljs-string">"github.com/iov-one/weave.Address"</span>];
    <span class="hljs-built_in">bytes</span> order_book_id = <span class="hljs-number">3</span> [(gogoproto.customname) = <span class="hljs-string">"OrderBookID"</span>];
    coin.Coin offer = <span class="hljs-number">4</span>;
    Amount price = <span class="hljs-number">5</span>;
}
</code></pre>
<p>As you can see above w*e define type necessary fields that will be used by <code>handler</code> to interact with application state</p></li>
</ul>
<p>After defining your state and messages run <code>make protoc</code> and make sure <code>prototool</code> creates your <code>codec.pb.go</code> file successfully.
Now we have scaffold of our application thanks to auto-generated <code>codec.pb.go</code> file.</p></li>
<li><h4><a class="anchor" aria-hidden="true" id="messages"></a><a href="#messages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Messages</h4>
<blockquote>
<p><a href="https://github.com/iov-one/tutorial/pull/2">PR#2</a>: <em>Create msgs</em></p>
</blockquote>
<p>This is where we wrap our auto generated message types with useful and vital functionalities. Before getting into this section I want to remind you <em>validation</em> is <strong>EXTREMELY</strong>  important. First create your <code>msg.go</code> file. This is where the magic will happen :grin:</p>
<p>Lets bind a path to our new message</p>
<pre><code class="hljs css language-go"><span class="hljs-keyword">const</span> (
    pathCreateOrderBook = <span class="hljs-string">"order/create_book"</span>
)
</code></pre>
<p>After that ensure your message is a <code>weave.Msg</code></p>
<pre><code class="hljs css language-go"><span class="hljs-keyword">var</span> _ weave.Msg = (*CreateOrderBookMsg)(<span class="hljs-literal">nil</span>)
</code></pre>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m CreateOrderBookMsg)</span> <span class="hljs-title">Validate</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> {
    <span class="hljs-keyword">if</span> err := m.Metadata.Validate(); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">"metadata"</span>)
    }
    <span class="hljs-keyword">if</span> err := validID(m.MarketID); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">"market id"</span>)
    }
    <span class="hljs-keyword">if</span> !coin.IsCC(m.AskTicker) {
        <span class="hljs-keyword">return</span> errors.Wrapf(errors.ErrCurrency, <span class="hljs-string">"Invalid Ask Ticker: %s"</span>, m.AskTicker)
    }
    <span class="hljs-keyword">if</span> !coin.IsCC(m.BidTicker) {
        <span class="hljs-keyword">return</span> errors.Wrapf(errors.ErrCurrency, <span class="hljs-string">"Invalid Bid Ticker: %s"</span>, m.BidTicker)
    }
    <span class="hljs-keyword">if</span> m.BidTicker &lt;= m.AskTicker {
        <span class="hljs-keyword">return</span> errors.Wrapf(errors.ErrCurrency, <span class="hljs-string">"ask (%s) must be before bid (%s)"</span>, m.AskTicker, m.BidTicker)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">validID</span><span class="hljs-params">(id []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">error</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(id) == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> errors.Wrap(errors.ErrEmpty, <span class="hljs-string">"id missing"</span>)
    }
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(id) != <span class="hljs-number">8</span> {
        <span class="hljs-keyword">return</span> errors.Wrap(errors.ErrInput, <span class="hljs-string">"id is invalid length (expect 8 bytes)"</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>You must have notice we even validate if <code>ID</code>'s lenght is not 0 and equal to 8 and tickers are actually string tickers. <strong>Remember</strong> more validation more solid your application is. If you <strong>constrain</strong> possible inputs, it is <strong>less</strong> checks you must do in the business logic.</p></li>
<li><h4><a class="anchor" aria-hidden="true" id="models"></a><a href="#models" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Models</h4>
<blockquote>
<p><a href="https://github.com/iov-one/tutorial/pull/6">PR#6</a>: <em>Create models</em></p>
</blockquote>
<p>We defined our state in <a href="#codec">codec section</a>. In order to use models in weave we have to wrap our model with some functionalities and enforce it is a <strong>morm.Model</strong></p>
<p>Ensure our <em>OrderBook</em> fulfills <strong>morm.Model</strong>. This is just a helper so the compiler will complain loudly here if you forget to implement a method. Guaranteeing it <em>I am trying to implement this interface</em>.</p>
<pre><code class="hljs css language-go"><span class="hljs-keyword">var</span> _ morm.Model = (*OrderBook)(<span class="hljs-literal">nil</span>)
</code></pre>
<p>Now lets work on our models identity</p>
<blockquote>
<p>How identity works in weave?</p>
</blockquote>
<ul>
<li><h4><a class="anchor" aria-hidden="true" id="auto-incremented-identities"></a><a href="#auto-incremented-identities" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auto incremented identities</h4>
<p><code>morm.Model</code> covers auto incremented IDs for you. All you have to define <code>GetID</code> and <code>SetID</code> methods. If you defined <code>bytes id = 2 [(gogoproto.customname) = &quot;ID&quot;];</code>  on <code>codec.proto</code> you do not even need to write <code>GetID</code> method by yourself, Thanks to prototool it will be generated automatically. You will only need to define <em>SetID</em> method.</p></li>
<li><h4><a class="anchor" aria-hidden="true" id="custom-identity"></a><a href="#custom-identity" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom identity</h4>
<p>For using your custom identity do not define <code>bytes id = 2 [(gogoproto.customname) = &quot;ID&quot;];</code> on <code>codec.proto</code>. You can use any other field as index with logic on top. Just write <code>SetID</code> and <code>GetID</code> logic that uses your index.</p></li>
</ul>
<p>Now you see how indexing works in <strong>weave</strong>. Lets see the other wonders of <strong>weave</strong>.</p>
<p>In order to our model to fulfill <strong>Model</strong> it must be <a href="https://github.com/iov-one/weave/blob/master/orm/interfaces.go#L34">Clonable</a>.</p>
<p>This is how you ensure it:</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *OrderBook)</span> <span class="hljs-title">Copy</span><span class="hljs-params">()</span> <span class="hljs-title">orm</span>.<span class="hljs-title">CloneableData</span></span> {
    <span class="hljs-keyword">return</span> &amp;OrderBook{
        Metadata:      o.Metadata.Copy(),
        ID:            copyBytes(o.ID),
        MarketID:      copyBytes(o.MarketID),
        AskTicker:     o.AskTicker,
        BidTicker:     o.BidTicker,
        TotalAskCount: o.TotalAskCount,
        TotalBidCount: o.TotalBidCount,
    }
}
</code></pre>
<p>Another point <strong>Model</strong> enforces is <code>Validate</code> method.</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *OrderBook)</span> <span class="hljs-title">Validate</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> {
    <span class="hljs-keyword">if</span> err := isGenID(o.ID, <span class="hljs-literal">true</span>); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> err
    }
    <span class="hljs-keyword">if</span> err := isGenID(o.MarketID, <span class="hljs-literal">false</span>); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">"market id"</span>)
    }
    <span class="hljs-keyword">if</span> !coin.IsCC(o.AskTicker) {
        <span class="hljs-keyword">return</span> errors.Wrap(errors.ErrModel, <span class="hljs-string">"invalid ask ticker"</span>)
    }
    <span class="hljs-keyword">if</span> !coin.IsCC(o.BidTicker) {
        <span class="hljs-keyword">return</span> errors.Wrap(errors.ErrModel, <span class="hljs-string">"invalid bid ticker"</span>)
    }
    <span class="hljs-keyword">if</span> o.TotalAskCount &lt; <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> errors.Wrap(errors.ErrModel, <span class="hljs-string">"negative total ask count"</span>)
    }
    <span class="hljs-keyword">if</span> o.TotalBidCount &lt; <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> errors.Wrap(errors.ErrModel, <span class="hljs-string">"negative total bid count"</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<blockquote>
<p>I want to point out again and make it persistent in your mind: Extensive <strong>Validation</strong> is crucial.</p>
</blockquote></li>
<li><h4><a class="anchor" aria-hidden="true" id="buckets"></a><a href="#buckets" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Buckets</h4>
<blockquote>
<p><a href="https://github.com/iov-one/tutorial/pull/8">PR#8</a>: <em>Create buckets</em>
<br>
<a href="https://github.com/iov-one/tutorial/pull/9">PR#9</a>: <em>Add indexer for market using marketID, askTicker, bidTicker</em></p>
</blockquote>
<p>Buckets are the components that we will use to interact with the KV store. It is our data warehouse.
<br>
Check out <a href="https://github.com/iov-one/tutorial/blob/master/morm/model_bucket.go#L40">morm</a> package. It is enhanced version of <a href="https://github.com/iov-one/weave/tree/master/orm">weave/orm</a> with indexes for making queries easier.</p>
<blockquote>
<p><strong><em>FYI</em></strong> whenever you have questions in your mind about the internals check out <code>weave</code> source code. It is very well documented. Please feel free to add <a href="https://github.com/iov-one/weave/issues">issues</a> if you think there is something under documented or confusing.</p>
</blockquote>
<p>Lets dive in to code now.</p>
<p>First define <code>MarketBucket</code> that will hold <code>Market</code> informations and write a function creates a market. This is a basic <code>morm/model_bucket</code> without any indexes.</p>
<pre><code class="hljs css language-go"><span class="hljs-keyword">type</span> MarketBucket <span class="hljs-keyword">struct</span> {
    morm.ModelBucket
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMarketBucket</span><span class="hljs-params">()</span> *<span class="hljs-title">MarketBucket</span></span> {
    b := morm.NewModelBucket(<span class="hljs-string">"market"</span>, &amp;Market{})
    <span class="hljs-keyword">return</span> &amp;MarketBucket{
        ModelBucket: b,
    }
}
</code></pre>
<p>Now create your <code>OrderBookBucket</code> with indexes. Indexes enable us inserting and querying models with ease. You can think is as SQL indexes.</p>
<pre><code class="hljs css language-go"><span class="hljs-keyword">type</span> OrderBookBucket <span class="hljs-keyword">struct</span> {
    morm.ModelBucket
}

<span class="hljs-comment">// NewOrderBookBucket initates orderbook with required indexes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewOrderBookBucket</span><span class="hljs-params">()</span> *<span class="hljs-title">OrderBookBucket</span></span> {
    b := morm.NewModelBucket(<span class="hljs-string">"orderbook"</span>, &amp;OrderBook{},
        morm.WithIndex(<span class="hljs-string">"market"</span>, marketIDindexer, <span class="hljs-literal">false</span>),
        morm.WithIndex(<span class="hljs-string">"marketWithTickers"</span>, marketIDTickersIndexer, <span class="hljs-literal">true</span>),
    )

    <span class="hljs-keyword">return</span> &amp;OrderBookBucket{
        ModelBucket: b,
    }
}
</code></pre>
<p><em>marketIDindexer</em> is an index with only market id. This is a simple index form to implement.
It just bindinds OrderBook to a MarketId(<em>bytes</em>)</p>
<p>In <code>weave</code> we use uniformed <em>bytes</em> as indexes. This improves performance.</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">marketIDindexer</span><span class="hljs-params">(obj orm.Object)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> {
    <span class="hljs-keyword">if</span> obj == <span class="hljs-literal">nil</span> || obj.Value() == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>
    }
    ob, ok := obj.Value().(*OrderBook)
    <span class="hljs-keyword">if</span> !ok {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.Wrapf(errors.ErrState, <span class="hljs-string">"expected orderbook, got %T"</span>, obj.Value())
    }
    <span class="hljs-keyword">return</span> ob.MarketID, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>You must have ideas flying around on your mind like <strong>how are we going to make an compound index? Really!? Is it all weave has?</strong></p>
<p><br>
Do not worry. <strong>Weave</strong> is like a swiss knife with a lot of blockchain features.</p>
<p>Now it is time for a compound index.
Here is how we create compound index for morm buckets:</p>
<pre><code class="hljs css language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BuildMarketIDTickersIndex</span><span class="hljs-params">(orderbook *OrderBook)</span> []<span class="hljs-title">byte</span></span> {
    askTickerByte := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>, tickerByteSize)
    <span class="hljs-built_in">copy</span>(askTickerByte, orderbook.AskTicker)

    bidTickerByte := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>, tickerByteSize)
    <span class="hljs-built_in">copy</span>(bidTickerByte, orderbook.BidTicker)

    <span class="hljs-keyword">return</span> bytes.Join([][]<span class="hljs-keyword">byte</span>{orderbook.MarketID, askTickerByte, bidTickerByte}, <span class="hljs-literal">nil</span>)
}
</code></pre>
<p><em>BuildMarketIDTickersIndex =  indexByteSize = 8(MarketID) + ask ticker size + bid ticker size</em></p>
<p>Sample market id index with tickers = 000000056665820070797900</p>
<p>000000056665820070797900 = 00000005(<strong>MarketID = 5</strong>) + 6665200(<strong>BAR ticker in bytes</strong>) + 70797900(<strong>FOO ticker in bytes</strong>)</p></li>
</ol>
<h2><a class="anchor" aria-hidden="true" id="prs"></a><a href="#prs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PRs</h2>
<ul>
<li><a href="https://github.com/iov-one/tutorial/pull/1">PR#1</a>: <em>Create order book models</em></li>
<li><a href="https://github.com/iov-one/tutorial/pull/2">PR#2</a>: <em>Create msgs</em></li>
<li><a href="https://github.com/iov-one/tutorial/pull/6">PR#6</a>: <em>Create models</em></li>
<li><a href="https://github.com/iov-one/tutorial/pull/8">PR#8</a>: <em>Create buckets</em></li>
<li><a href="https://github.com/iov-one/tutorial/pull/9">PR#9</a>: <em>Add indexer for market using marketID, askTicker, bidTicker</em></li>
<li><a href="https://github.com/iov-one/tutorial/pull/10">PR#11</a>: <em>Create handlers</em></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="discussions-compiled-from-prs"></a><a href="#discussions-compiled-from-prs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Discussions compiled from PRs</h2>
<blockquote>
<p>Is weave.Metadata metadata always required?</p>
</blockquote>
<p>This allows you to upgrade the code on chain without downtime
reference: <a href="https://github.com/iov-one/weave/tree/master/migration/doc.go">weave/migration</a></p>
<blockquote>
<p>What is the best practices for using proto value types on modeling currency amount, IDs, timestamp?</p>
</blockquote>
<ul>
<li>Currency example <a href="https://github.com/iov-one/weave/tree/master/coin">weave/x/coin</a></li>
<li>For incremetal ID use <code>orm.IDGenBucket</code> <em>TODO: Add <code>morm/ModelBucket</code> when it is merged into weave</em></li>
<li>For Timestamp <a href="https://github.com/iov-one/weave/blob/master/time.go">weave.UnixTime</a></li>
</ul>
<blockquote>
<p>How to identify users in state.proto implementation</p>
</blockquote>
<ul>
<li>Use <a href="https://github.com/iov-one/weave/blob/master/x/aswap/codec.proto">weave.Address</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="write-document-and-specs-for-everything-literally-everything-eg-weave-tutorial-orderbook-codec-https-githubcom-iov-one-tutorial-blob-master-x-orderbook-codecproto"></a><a href="#write-document-and-specs-for-everything-literally-everything-eg-weave-tutorial-orderbook-codec-https-githubcom-iov-one-tutorial-blob-master-x-orderbook-codecproto" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>!! <strong>Write document and specs for everything. Literally <em>EVERYTHING</em></strong> eg. <a href="https://github.com/iov-one/tutorial/blob/master/x/orderbook/codec.proto">weave/tutorial/orderbook/codec</a></h3>
<blockquote>
<p>Can you elaborate what m.Metadata.Validate() does in detail?</p>
</blockquote>
<ul>
<li><em><a href="https://github.com/iov-one/tutorial/pull/2#discussion_r289601156">Discussion link</a></em></li>
<li>Currently, it just Validates that Metadata is not nil and there is a positive integer schema set. But in general, all structs used in public APIs have a Validate() error method. And when we embed one in another object, we can just Validate all the sub-structures and return the wrapped error, just giving the context why we were calling it (this makes more sense for a Coin which can be used in multiple fields, than a Metadata)</li>
</ul>
<blockquote>
<p>weave/migration NoModification and RefuseMigration difference</p>
</blockquote>
<ul>
<li><em><a href="https://github.com/iov-one/tutorial/pull/2#discussion_r289602376">Discussion link</a></em></li>
<li>For registering the schema 1, you should always have migration.NoModification to initialize it. For future schemas, they can be a soft change (with a migration path), or a hard break (no migration path). Hard schema changes in models may be next to impossible to implement on a chain without a strong manual hard-fork.</li>
</ul>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/doc-saurus/docs/weave-tutorial1"><span class="arrow-prev">← </span><span>Getting Started</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#prs">PRs</a></li><li><a href="#discussions-compiled-from-prs">Discussions compiled from PRs</a><ul class="toc-headings"><li><a href="#write-document-and-specs-for-everything-literally-everything-eg-weave-tutorial-orderbook-codec-https-githubcom-iov-one-tutorial-blob-master-x-orderbook-codecproto">!! <strong>Write document and specs for everything. Literally <em>EVERYTHING</em></strong> eg. <a href="https://github.com/iov-one/tutorial/blob/master/x/orderbook/codec.proto">weave/tutorial/orderbook/codec</a></a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/doc-saurus/" class="nav-home"><img src="/doc-saurus/img/favicon.ico" alt="Weave" width="66" height="58"/></a><div><h5>Docs</h5><a href="/doc-saurus/docs/en/doc1.html">Getting Started (or other categories)</a><a href="/doc-saurus/docs/en/doc2.html">Guides (or other categories)</a><a href="/doc-saurus/docs/en/doc3.html">API Reference (or other categories)</a></div><div><h5>Community</h5><a href="/doc-saurus/en/users.html">User Showcase</a><a href="https://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://discordapp.com/">Project Chat</a><a href="https://twitter.com/" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/doc-saurus/blog">Blog</a><a href="https://github.com/">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><a href="https://opensource.facebook.com/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/doc-saurus/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2019 Your Name or Your Company Name</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'd30828ad9add70bd3bc0fc8484a7033d',
                indexName: 'weave-tutorial',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>